# docker-compose.yml
# Single-app mode
# Run deno task build before docker-compose up
# Optional: run deno cache first, then mount runtime/deno-cache for faster startup

services:
  webcube2027:
    build:
      context: .
      dockerfile: Dockerfile
      target: base
    container_name: webcube2027-app
    restart: unless-stopped
    stop_grace_period: 5s
    user: '0:0'
    ports:
      - '3000:3000'
    command: ["deno","run","-A","dist/server.js"]
    environment:
      - DENO_ENV=production
    volumes:
      - .:/app
      - ${DENO_CACHE_DIR:-./runtime/deno-cache}:/deno-dir
    healthcheck:
      test:
        [
          'CMD-SHELL',
          "curl -f -s -o /dev/null -w '%{http_code}' http://localhost:3000/ | grep -q '^2' || exit 1"
        ]
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 5s
    logging:
      driver: 'local'
      options:
        max-size: '10m'
        max-file: '3'
        compress: 'true'

networks:
  default:
    driver: bridge
